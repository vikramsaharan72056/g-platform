// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==================== ENUMS ====================

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  DEACTIVATED
}

enum UserRole {
  PLAYER
  ADMIN
  SUPER_ADMIN
}

enum KycStatus {
  NONE
  PENDING
  VERIFIED
  REJECTED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  BET_PLACED
  BET_WON
  BET_REFUND
  BONUS_CREDIT
  BONUS_DEBIT
  ADMIN_CREDIT
  ADMIN_DEBIT
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
  FAILED
  CANCELLED
}

enum GameType {
  CARD_GAME
  CRASH_GAME
  DICE_GAME
  SLOT_GAME
  ROULETTE_GAME
}

enum RoundStatus {
  WAITING
  BETTING
  LOCKED
  PLAYING
  RESULT
  SETTLED
  CANCELLED
}

enum BetStatus {
  PLACED
  WON
  LOST
  REFUNDED
  CANCELLED
}

enum DepositStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
  ON_HOLD
}

enum AdminControlType {
  FORCE_RESULT
  WIN_RATE_CONTROL
  BET_LIMITS
  PLAYER_LIMIT
  ROUND_TIMER
  MAINTENANCE
}

// ==================== MODELS ====================

model User {
  id               String     @id @default(uuid())
  email            String     @unique
  password         String
  displayName      String?
  phone            String?    @unique
  avatar           String?

  // 2FA
  twoFactorEnabled Boolean    @default(false)
  twoFactorSecret  String?

  // KYC
  kycStatus        KycStatus  @default(NONE)
  kycDocuments     Json?

  // Status
  status           UserStatus @default(ACTIVE)
  role             UserRole   @default(PLAYER)

  // Referral
  referralCode     String?    @unique
  referredBy       String?

  // Relations
  wallet           Wallet?
  bets             Bet[]
  transactions     Transaction[]
  loginHistory     LoginHistory[]
  notifications    Notification[]
  depositRequests  DepositRequest[]
  withdrawalRequests WithdrawalRequest[]

  // Timestamps
  lastLoginAt      DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  @@index([email])
  @@index([status])
  @@index([role])
  @@map("users")
}

model Wallet {
  id             String        @id @default(uuid())
  userId         String        @unique
  user           User          @relation(fields: [userId], references: [id])

  balance        Decimal       @default(0) @db.Decimal(12, 2)
  bonusBalance   Decimal       @default(0) @db.Decimal(12, 2)
  totalDeposited Decimal       @default(0) @db.Decimal(12, 2)
  totalWithdrawn Decimal       @default(0) @db.Decimal(12, 2)
  totalBetAmount Decimal       @default(0) @db.Decimal(12, 2)
  totalWon       Decimal       @default(0) @db.Decimal(12, 2)
  totalLost      Decimal       @default(0) @db.Decimal(12, 2)

  // Optimistic locking
  version        Int           @default(0)

  transactions   Transaction[]

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("wallets")
}

model Transaction {
  id             String            @id @default(uuid())

  userId         String
  user           User              @relation(fields: [userId], references: [id])
  walletId       String
  wallet         Wallet            @relation(fields: [walletId], references: [id])

  type           TransactionType
  amount         Decimal           @db.Decimal(12, 2)
  balanceBefore  Decimal           @db.Decimal(12, 2)
  balanceAfter   Decimal           @db.Decimal(12, 2)

  // Payment details
  paymentMethod  String?
  paymentProof   String?
  utrNumber      String?
  bankDetails    Json?

  // Status & Admin
  status         TransactionStatus @default(PENDING)
  adminRemarks   String?
  processedBy    String?
  processedAt    DateTime?

  // Game reference
  betId          String?
  gameRoundId    String?

  description    String?

  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([userId])
  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

model Game {
  id                String       @id @default(uuid())
  name              String       @unique
  slug              String       @unique
  type              GameType

  // Configuration
  minBet            Decimal      @db.Decimal(12, 2)
  maxBet            Decimal      @db.Decimal(12, 2)
  roundDuration     Int          // seconds
  bettingWindow     Int          // seconds
  maxPlayersPerRoom Int?

  // House Edge
  houseEdge         Decimal      @default(5) @db.Decimal(5, 2)

  // Admin Controls
  isActive          Boolean      @default(true)
  isMaintenanceMode Boolean      @default(false)

  // Game-specific config
  config            Json?

  // Assets
  thumbnail         String?
  banner            String?

  // Relations
  rounds            GameRound[]
  adminControls     GameAdminControl[]

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@map("games")
}

model GameRound {
  id              String        @id @default(uuid())

  gameId          String
  game            Game          @relation(fields: [gameId], references: [id])

  roundNumber     Int

  // Timing
  status          RoundStatus   @default(WAITING)
  bettingStartAt  DateTime
  bettingEndAt    DateTime
  playStartAt     DateTime?
  resultAt        DateTime?
  settledAt       DateTime?

  // Result
  result          Json?
  resultHash      String?
  resultSeed      String?

  // Admin Override
  isOverridden    Boolean       @default(false)
  overriddenBy    String?
  overrideReason  String?
  originalResult  Json?

  // Stats
  totalBets       Int           @default(0)
  totalBetAmount  Decimal       @default(0) @db.Decimal(14, 2)
  totalPayout     Decimal       @default(0) @db.Decimal(14, 2)
  housePnl        Decimal       @default(0) @db.Decimal(14, 2)

  // Relations
  bets            Bet[]
  roundResults    RoundResult[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([gameId, roundNumber])
  @@index([gameId])
  @@index([status])
  @@index([createdAt])
  @@map("game_rounds")
}

model Bet {
  id              String      @id @default(uuid())

  userId          String
  user            User        @relation(fields: [userId], references: [id])
  gameRoundId     String
  gameRound       GameRound   @relation(fields: [gameRoundId], references: [id])

  amount          Decimal     @db.Decimal(12, 2)
  betType         String
  betData         Json?

  odds            Decimal?    @db.Decimal(8, 4)
  potentialPayout Decimal?    @db.Decimal(14, 2)
  actualPayout    Decimal     @default(0) @db.Decimal(14, 2)

  status          BetStatus   @default(PLACED)
  settledAt       DateTime?

  placeTxnId      String?
  payoutTxnId     String?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId])
  @@index([gameRoundId])
  @@index([status])
  @@index([createdAt])
  @@map("bets")
}

model RoundResult {
  id            String    @id @default(uuid())

  gameRoundId   String
  gameRound     GameRound @relation(fields: [gameRoundId], references: [id])

  resultType    String
  resultData    Json

  createdAt     DateTime  @default(now())

  @@index([gameRoundId])
  @@map("round_results")
}

model GameAdminControl {
  id           String           @id @default(uuid())

  gameId       String
  game         Game             @relation(fields: [gameId], references: [id])

  controlType  AdminControlType
  config       Json

  isActive     Boolean          @default(true)

  createdBy    String
  expiresAt    DateTime?

  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([gameId])
  @@index([controlType])
  @@map("game_admin_controls")
}

model DepositRequest {
  id             String        @id @default(uuid())

  userId         String
  user           User          @relation(fields: [userId], references: [id])

  amount         Decimal       @db.Decimal(12, 2)

  paymentQrId    String
  paymentQr      PaymentQR     @relation(fields: [paymentQrId], references: [id])

  screenshotUrl  String?
  utrNumber      String?
  paymentMethod  String

  status         DepositStatus @default(PENDING)
  reviewedBy     String?
  reviewRemarks  String?
  reviewedAt     DateTime?

  transactionId  String?

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([userId])
  @@index([status])
  @@map("deposit_requests")
}

model PaymentQR {
  id             String          @id @default(uuid())

  name           String
  type           String
  qrCodeUrl      String
  upiId          String?
  bankDetails    Json?

  isActive       Boolean         @default(true)
  dailyLimit     Decimal?        @db.Decimal(14, 2)
  dailyCollected Decimal         @default(0) @db.Decimal(14, 2)

  deposits       DepositRequest[]

  createdBy      String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@map("payment_qrs")
}

model WithdrawalRequest {
  id             String             @id @default(uuid())

  userId         String
  user           User               @relation(fields: [userId], references: [id])

  amount         Decimal            @db.Decimal(12, 2)

  payoutMethod   String
  payoutDetails  Json

  status         WithdrawalStatus   @default(PENDING)
  reviewedBy     String?
  reviewRemarks  String?
  reviewedAt     DateTime?

  paymentProof   String?
  paymentRef     String?

  transactionId  String?

  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@index([userId])
  @@index([status])
  @@map("withdrawal_requests")
}

model LoginHistory {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])

  ipAddress   String
  userAgent   String
  deviceInfo  Json?
  location    String?

  loginAt     DateTime @default(now())

  @@index([userId])
  @@map("login_history")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  type      String
  title     String
  body      String
  data      Json?
  isRead    Boolean  @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Json
  description String?

  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

model AuditLog {
  id         String   @id @default(uuid())

  userId     String
  action     String
  resource   String
  resourceId String
  details    Json?
  ipAddress  String?

  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
